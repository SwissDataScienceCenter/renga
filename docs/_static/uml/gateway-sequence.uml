@startuml

autonumber

!define BLACK   #363D5D
!define RED     #F6363F
!define PINK    #F6216E
!define MAGENTA #A54FBD
!define GREEN   #37A77C
!define YELLOW  #F97A00
!define BLUE    #1E98F2
!define CYAN    #25AFCA
!define WHITE   #FEF2DC

' Base Setting
skinparam Shadowing false
skinparam BackgroundColor white
skinparam ComponentStyle uml2
skinparam Default {
  FontName  'Hiragino Sans'
  FontColor BLACK
  FontSize  20
  FontStyle plain
}

skinparam Sequence {
  ArrowThickness 2
  ArrowColor RED
  ActorBorderThickness 1
  LifeLineBorderColor GREEN
  ParticipantBorderThickness 0
}
skinparam Participant {
  BackgroundColor BLACK
  BorderColor BLACK
  FontColor #FFFFFF
}

skinparam Actor {
  BackgroundColor BLACK
  BorderColor BLACK
}

hide footbox
skinparam shadowing false

participant UI
participant "API Gateway"
participant Keycloak
participant GitLab

autonumber stop

== User login ==
group OAuth2 flow
  UI -> "API Gateway": open in browser: /api/auth/login

  "API Gateway" -> Keycloak: redirect
  "Keycloak" -> "Keycloak"
  note right: User enters credentials
  "API Gateway" <- Keycloak: redirect (incl. authorization code)
  group Server-side communication
    "API Gateway" -> Keycloak: authorization code
    "Keycloak" -> "Keycloak"
    note right: Validate authorization code
    "API Gateway" <- Keycloak: access token, refresh token, ID token
  end
  UI <- "API Gateway": access token, refresh token, ID token
end

== On startup ==
"API Gateway" <- Keycloak: Keycloak public key

== Resource access ==
  UI -> "API Gateway": /api/some_resource (access token)
  "API Gateway" -> "API Gateway"
  note right: Validate access token (public key)
  "API Gateway" -> GitLab: /api/v4/some_resource (GitLab sudo token, user id)
  GitLab -> GitLab
  note right: Process request
  "API Gateway" <- GitLab: API response
  UI <- "API Gateway": API response
@enduml
