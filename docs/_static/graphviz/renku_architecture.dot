strict digraph architecture {
  compound=true;
  newrank=true;

  graph [fontname="Raleway", nodesep="0.8"];
  node [shape="rect", style="filled,rounded", fontname="Raleway"];
  edge [fontname="Raleway"]


  # main off-the-shelf services
  GitLab [fillcolor="lightblue"]
  Keycloak [fillcolor="lightblue"]
  JupyterHub [fillcolor="lightblue"]

  # gitlab-ci
  runner [fillcolor="lightblue"]
  registry [fillcolor="lightblue"]

  # clients
  UI [fillcolor="#f4d142"]
  CLI [fillcolor="#f4d142"]

  # custom services
  gateway [fillcolor="#f4d142"]
  "notebook-service" [fillcolor="#f4d142"]
  notebook [shape="rect", fillcolor="#f4d142"]
  "init-container" [shape="rect", fillcolor="#f4d142"]

  # storage
  storage [fillcolor="lightblue", label="object store", shape="cylinder"]

  subgraph cluster_clients {
    label="Clients"
    UI
    CLI
    {rank=same; UI, CLI};
  }

  subgraph cluster_jupyterhub{
    label="JupyterHub components"
    "notebook-service" -> JupyterHub [label="API"]

    subgraph cluster_notebook {
        label="notebook pod"
        style="dashed";
        "init-container"
        notebook
        {rank=same; "init-container", notebook}
      }
  }

  subgraph cluster_gitlab {
    label="GitLab components"
    GitLab -> runner [label="start CI job", lhead=cluster_ci]
    runner -> registry [label="push image"]
    registry -> GitLab [label="register image"]
    {rank=same; "runner", registry};
  }

  JupyterHub -> GitLab [label="OAuth"]
  "notebook" -> "GitLab" [label="commit back"]
  "init-container" -> "GitLab" [label="clone repo"]

  CLI -> GitLab [label="git push" fontname="courier"]
  CLI -> gateway [label="API"]
  UI -> gateway [label="API"]
  GitLab -> Keycloak [label="OAuth"]
  gateway -> GitLab [label="proxy"]
  gateway -> "notebook-service" [label="proxy", lhead=cluster_jupyterhub]
  gateway -> Keycloak [label="OIDC"]
  "notebook-service" -> GitLab [label="repo permissions\nimage build status"]
  JupyterHub -> notebook [label="spawn", lhead=cluster_notebook]
  "notebook" -> GitLab [label="fetch image", lhead=cluster_notebook]
  registry -> storage [label="fetch/push image"]
  CLI -> storage [label="pull/push LFS"]
  "init-container" -> storage [label="pull/push LFS", ltail=cluster_notebook]

  { rank=same; GitLab; Keycloak}
  { rank=same; registry; storage; }
}
