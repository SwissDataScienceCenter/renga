strict digraph architecture {
  compound=true;
  newrank=true;
  ordering=out;

  graph [fontname="Raleway", nodesep="0.8"];
  node [shape="rect", style="filled,rounded", fontname="Raleway"];
  edge [fontname="Raleway"]


  # main off-the-shelf services
  GitLab [fillcolor="lightblue"]
  Keycloak [fillcolor="lightblue"]
  JupyterHub [label="Notebook service" fillcolor="#f4d142" URL="../developer/services/notebooks_service.html" target="_graphviz"]
  Notebook [fillcolor="lightblue"]

  # clients
  UI [fillcolor="#f4d142"]
  CLI [fillcolor="#f4d142"]

  gateway [fillcolor="#f4d142"]

  storage [fillcolor="lightblue", label="Object store", shape="cylinder"]

  subgraph cluster_clients {
    label="Clients"
    UI
    CLI
    Notebook
    {rank=same; UI, CLI, Notebook};
  }

  JupyterHub -> Notebook [label=" spawn"]

  CLI -> GitLab [label=" git pull/push" fontname="courier"]
  Notebook -> GitLab [label=" git pull/push" fontname="courier"]
  Notebook -> storage [label=" pull/push LFS\n fetch image"]
  CLI -> gateway [label=" API"]
  UI -> gateway [label=" API"]
  GitLab -> Keycloak [label=" OAuth"]
  JupyterHub -> GitLab [label=" OAuth"]
  gateway -> GitLab [label=" proxy API"]
  gateway -> JupyterHub [label=" proxy API"]
  gateway -> Keycloak [label=" OIDC"]
  GitLab -> storage [label=" fetch/push image"]
  CLI -> storage [label=" pull/push LFS"]

  {rank=0; UI}
}
