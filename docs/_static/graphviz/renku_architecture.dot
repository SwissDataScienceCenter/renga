digraph architecture {
  compound=true;


  GitLab [color="lightblue", style="filled"]
  Keycloak [color="lightblue", style="filled"]
  UI [color="#f4d142", style="filled"]
  CLI [color="#f4d142", style="filled"]
  gateway [color="#f4d142", style="filled"]
  JupyterHub [color="lightblue", style="filled"]
  "notebook-service" [color="#f4d142", style="filled"]
  spawner [color="#f4d142", style="filled"]
  "notebook" [shape="rect", color="#f4d142", style="filled"]
  "init-container" [shape="rect", color="#f4d142", style="filled"]
  runner [color="lightblue", style="filled"]
  "build-container" [color="lightblue", style="filled"]

  subgraph auth_layer {
    GitLab -> Keycloak [label="OIDC"]
    // {rank=same; Keycloak, GitLab};
  }

  subgraph cluster_client_side_apps {
    label="User-facing applications"
    UI
    CLI
    {rank=same; UI, CLI};
  }

  subgraph cluster_jupyterhub{
    label="JupyterHub Components"
    JupyterHub -> spawner [label="notebook spawn"]
    spawner -> notebook [label="spawn", lhead=cluster_notebook];
    JupyterHub -> notebook [label="proxy redirect"]
    "notebook-service" -> JupyterHub [label="notebook API"]

    subgraph cluster_notebook {
      label="notebook pod"
      style="dashed";
      "init-container"
      "notebook"
    }
  }

  subgraph cluster_ci {
    rankdir=LR;
    label="GitLab CI"
    runner -> "build-container" [label="trigger build"]
    {rank=same; "runner", "build-container"};
  }

  spawner -> GitLab [label="repo permissions"]
  JupyterHub -> GitLab [label="OAuth"]
  "notebook" -> "GitLab" [label="commit back"]
  "init-container" -> "GitLab" [label="clone repo"]
  "build-container" -> GitLab [label="push image"]
  GitLab -> runner [label="start CI job", lhead=cluster_ci]

  CLI -> GitLab [label="push repo"]
  UI -> gateway [label="API elements"]
  gateway -> GitLab [label="Forward API request"]
  UI -> "notebook-service" [label="notebook URL"]
}
