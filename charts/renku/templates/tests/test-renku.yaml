apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-test"
  annotations:
    "helm.sh/hook": test-success
spec:
  initContainers:
  - name: renku-demo
    image: renku/renku-demo:latest
    env:
      - name: GITLAB_SUDO_TOKEN
        valueFrom:
          secretKeyRef:
            name: {{ template "renku.fullname" . }}
            key: gitlab-sudo-token
      - name: GITLAB_URL
        value: {{ template "http" . }}://{{ .Values.global.renku.domain }}{{ .Values.global.gitlab.urlPrefix }}
      - name: KEYCLOAK_ADMIN_PASSWORD
        valueFrom:
          secretKeyRef:
            name: {{ template "renku.fullname" . }}
            key: keycloak-password
      - name: KEYCLOAK_ADMIN_USER
        value: {{ .Values.keycloak.keycloak.username }}
      - name: KEYCLOAK_URL
        value: {{ template "http" . }}://{{ .Values.global.renku.domain }}
  containers:
  - name: {{ .Release.Name }}-test
    image: "{{ .Values.tests.image.repository }}:{{ .Values.tests.image.tag }}"
    env:
      - name: RENKU_ENDPOINT
        value: {{ template "http" . }}://{{ .Values.global.renku.domain }}
    lifecycle:
      preStop:
        exec:
          command: ["/tests/demo-cleanup.sh"]
  restartPolicy: Never
